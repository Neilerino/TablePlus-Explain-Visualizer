(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();const t={NO_QUERY_EDITOR:{title:"No Query Editor",message:"Please open a query editor tab."},NO_QUERY:{title:"No Query",message:"Please write or select a SQL query."},ALREADY_EXPLAINED:{title:"Query Already Has EXPLAIN",message:"Please remove the EXPLAIN statement first."},INVALID_QUERY:{title:"Invalid Query Type",message:"EXPLAIN only works with SELECT, INSERT, UPDATE, DELETE, or WITH queries."},NO_RESULT:{title:"No EXPLAIN Data",message:"The EXPLAIN query returned no data. Make sure you are connected to a PostgreSQL database."},NO_COLUMNS:{title:"Error",message:"No columns in result."},NO_PLAN_DATA:{title:"Error",message:"Could not extract EXPLAIN data."},INVALID_PLAN_STRUCTURE:{title:"Error",message:"Invalid EXPLAIN plan structure."},PARSE_ERROR:{title:"Error Parsing Plan",message:"Could not parse EXPLAIN JSON: {message}"}};class r{constructor(e){this.context=e,this.application=Application}getQueryEditor(){const e=this.context.currentQueryEditor();return e?{success:!0,editor:e}:{success:!1,error:"NO_QUERY_EDITOR"}}getQuery(){const e=this.getQueryEditor();if(!e.success)return e;const t=e.editor;let r=t.currentSelectedString();return r&&0!==r.trim().length||(r=t.value()),r&&0!==r.trim().length?{success:!0,query:r}:{success:!1,error:"NO_QUERY"}}executeQuery(e,t){this.context.execute(e,t)}displayHTML(e){this.context.loadHTML(e)}workingPath(){return Application.pluginRootPath()+"/com.tinyapp.TablePlus.PostgresExplain.tableplusplugin"}loadWebView(e){return this.context.loadFile(`${this.workingPath()}/${e}`,null)}sendDataToWebView(e,t){const r=JSON.stringify(t);e.evaluate(`window.ExplainViz.init(${r})`)}showAlert(e,t){this.context.alert(e,t)}showError(e,r=""){!function(e,r,s=""){const o=t[e]||{title:"Unexpected Error",message:s||"An unexpected error occurred."},n=o.message.replace("{message}",s);r.alert(o.title,n)}(e,this.context,r)}}function s(e,t=2){return e<1/t||e>t}function o(e){return n(e.Plan,null)}function n(e,t){const r=function(e){const t=(r=e["Plan Rows"]||0,o=e["Actual Rows"]||0,r&&0!==r?o/r:1);var r,o;return{name:e["Node Type"]||"Unknown",rawNode:e,details:{cost:e["Total Cost"]?e["Total Cost"].toFixed(2):"N/A",startupCost:e["Startup Cost"]?e["Startup Cost"].toFixed(2):"N/A",planRows:e["Plan Rows"]||"N/A",actualRows:e["Actual Rows"]||"N/A",actualTime:e["Actual Total Time"]?e["Actual Total Time"].toFixed(3):"N/A",startupTime:e["Actual Startup Time"]?e["Actual Startup Time"].toFixed(3):"N/A",relation:e["Relation Name"]||null,alias:e.Alias||null,schema:e.Schema||null,indexName:e["Index Name"]||null,joinType:e["Join Type"]||null,hashCond:e["Hash Cond"]||null,joinFilter:e["Join Filter"]||null,innerUnique:e["Inner Unique"]||null,parentRelationship:e["Parent Relationship"]||null,filter:e.Filter||null,sortKey:e["Sort Key"]?e["Sort Key"].join(", "):null,sortMethod:e["Sort Method"]||null,sortSpaceUsed:e["Sort Space Used"]||null,sortSpaceType:e["Sort Space Type"]||null,strategy:e.Strategy||null,groupKey:e["Group Key"]?e["Group Key"].join(", "):null,hashAggBatches:e["HashAgg Batches"]||null,peakMemoryUsage:e["Peak Memory Usage"]||null,hashBuckets:e["Hash Buckets"]||null,hashBatches:e["Hash Batches"]||null,sharedHitBlocks:e["Shared Hit Blocks"]||0,sharedReadBlocks:e["Shared Read Blocks"]||0,sharedDirtiedBlocks:e["Shared Dirtied Blocks"]||0,sharedWrittenBlocks:e["Shared Written Blocks"]||0,localHitBlocks:e["Local Hit Blocks"]||0,localReadBlocks:e["Local Read Blocks"]||0,tempReadBlocks:e["Temp Read Blocks"]||0,tempWrittenBlocks:e["Temp Written Blocks"]||0,ioReadTime:e["I/O Read Time"]||null,ioWriteTime:e["I/O Write Time"]||null,rowsRemovedByFilter:e["Rows Removed by Filter"]||null,rowsRemovedByJoinFilter:e["Rows Removed by Join Filter"]||null,heapFetches:e["Heap Fetches"]||null,exactHeapBlocks:e["Exact Heap Blocks"]||null,lossyHeapBlocks:e["Lossy Heap Blocks"]||null,workersPlanned:e["Workers Planned"]||null,workersLaunched:e["Workers Launched"]||null,output:e.Output?e.Output.join(", "):null,estimationAccuracy:t,estimationOff:s(t),loops:e["Actual Loops"]||1}}}(e),o=function(e,t){return t?e["Hash Cond"]?e["Hash Cond"]:e["Join Filter"]?e["Join Filter"]:e["Parent Relationship"]?e["Parent Relationship"]:null:null}(e,t),a={...r,children:[],edgeLabel:o};return e.Plans&&e.Plans.length>0&&(a.children=e.Plans.map(t=>n(t,e))),a}void 0!==e.g&&(e.g.runExplain=function(e){const t=new r(e);try{const e=t.getQuery();if(!e.success)return void t.showError(e.error);let r=e.query;r=function(e){return e?e.trim().replace(/;+$/,"").trim():""}(r);const s=function(e){return e&&0!==e.trim().length?/^\s*EXPLAIN/i.test(e)?{valid:!1,error:"ALREADY_EXPLAINED"}:/^\s*(SELECT|INSERT|UPDATE|DELETE|WITH)/i.test(e)?{valid:!0}:{valid:!1,error:"INVALID_QUERY"}:{valid:!1,error:"NO_QUERY"}}(r);if(!s.valid)return void t.showError(s.error);const n=function(e,t={}){const{analyze:r=!0,costs:s=!0,verbose:o=!0,buffers:n=!0,format:a="JSON"}=t,l=[];return r&&l.push("ANALYZE"),s&&l.push("COSTS"),o&&l.push("VERBOSE"),n&&l.push("BUFFERS"),a&&l.push(`FORMAT ${a}`),`EXPLAIN (${l.join(", ")}) ${e}`}(r);t.executeQuery(n,e=>{try{const s=function(e){if(!e||!e.rows||0===e.rows.length)return{success:!1,error:"NO_RESULT"};const t=Object.keys(e.columns||{});if(0===t.length)return{success:!1,error:"NO_COLUMNS"};const r=t[0],s=e.rows[0].raw(r);return s?{success:!0,data:s}:{success:!1,error:"NO_PLAN_DATA"}}(e);if(!s.success)return void t.showError(s.error);const n=function(e){try{let t=JSON.parse(e);return Array.isArray(t)&&t.length>0&&(t=t[0]),t&&t.Plan?{success:!0,data:t}:{success:!1,error:"INVALID_PLAN_STRUCTURE"}}catch(e){return{success:!1,error:"PARSE_ERROR",message:e.message}}}(s.data);if(!n.success)return void t.showError(n.error,n.message);const a=n.data,l=o(a),i="app/dist/index.html",u=t.loadWebView(i);t.sendDataToWebView(u,{query:r,planData:a,treeData:l})}catch(e){t.showAlert("Error Processing EXPLAIN",e.message||String(e))}})}catch(e){t.showAlert("Unexpected Error",e.message||String(e))}})})();
//# sourceMappingURL=explain.js.map