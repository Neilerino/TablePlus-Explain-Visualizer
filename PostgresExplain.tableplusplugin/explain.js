(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();const t={NO_QUERY_EDITOR:{title:"No Query Editor",message:"Please open a query editor tab."},NO_QUERY:{title:"No Query",message:"Please write or select a SQL query."},ALREADY_EXPLAINED:{title:"Query Already Has EXPLAIN",message:"Please remove the EXPLAIN statement first."},INVALID_QUERY:{title:"Invalid Query Type",message:"EXPLAIN only works with SELECT, INSERT, UPDATE, DELETE, or WITH queries."},NO_RESULT:{title:"No EXPLAIN Data",message:"The EXPLAIN query returned no data. Make sure you are connected to a PostgreSQL database."},NO_COLUMNS:{title:"Error",message:"No columns in result."},NO_PLAN_DATA:{title:"Error",message:"Could not extract EXPLAIN data."},INVALID_PLAN_STRUCTURE:{title:"Error",message:"Invalid EXPLAIN plan structure."},PARSE_ERROR:{title:"Error Parsing Plan",message:"Could not parse EXPLAIN JSON: {message}"}};class r{constructor(e){this.context=e,this.application=Application}getQueryEditor(){const e=this.context.currentQueryEditor();return e?{success:!0,editor:e}:{success:!1,error:"NO_QUERY_EDITOR"}}getQuery(){const e=this.getQueryEditor();if(!e.success)return e;const t=e.editor;let r=t.currentSelectedString();return r&&0!==r.trim().length||(r=t.value()),r&&0!==r.trim().length?{success:!0,query:r}:{success:!1,error:"NO_QUERY"}}executeQuery(e,t){this.context.execute(e,t)}displayHTML(e){this.context.loadHTML(e)}workingPath(){return Application.pluginRootPath()+"/com.tinyapp.TablePlus.PostgresExplain.tableplusplugin"}loadWebView(e){return this.context.loadFile(`${this.workingPath()}/${e}`,null)}sendDataToWebView(e,t){const r=JSON.stringify(t);e.evaluate(`window.ExplainViz.init(${r})`)}showAlert(e,t){this.context.alert(e,t)}showError(e,r=""){!function(e,r,s=""){const o=t[e]||{title:"Unexpected Error",message:s||"An unexpected error occurred."},n=o.message.replace("{message}",s);r.alert(o.title,n)}(e,this.context,r)}}function s(e,t=2){return e<1/t||e>t}function o(e,t="0"){e.id=t,e.children&&e.children.length>0&&e.children.forEach((e,r)=>{o(e,`${t}-${r}`)})}class n{constructor(e){this.metricExtractor=e}markCriticalPath(e){e.forEach(e=>{e.isOnCriticalPath=!0})}}class a extends n{constructor(e){super(e)}analyze(e){let t=[],r=0;const s=(e,o,n)=>{const a=n+this.metricExtractor(e),l=[...o,e];if(!e.children||0===e.children.length)return void(a>r&&(r=a,t=l));let i=0,c=null;e.children.forEach(e=>{const t=this.getSubtreeMetric(e);t>i&&(i=t,c=e)}),c&&s(c,l,a)};return s(e,[],0),this.markCriticalPath(t),t}getSubtreeMetric(e){let t=this.metricExtractor(e);if(e.children&&e.children.length>0){const r=e.children.map(e=>this.getSubtreeMetric(e));t+=Math.max(...r,0)}return t}}class l extends n{constructor(e){super(e)}analyze(e){let t=[],r=0;const s=(e,o,n)=>{const a=n+this.metricExtractor(e),l=[...o,e];if(!e.children||0===e.children.length)return void(a>r&&(r=a,t=l));let i=0,c=null;e.children.forEach(e=>{const t=this.getSubtreeMetric(e);t>i&&(i=t,c=e)}),c&&s(c,l,a)};return s(e,[],0),this.markCriticalPath(t),t}getSubtreeMetric(e){let t=this.metricExtractor(e);if(e.children&&e.children.length>0){const r=e.children.map(e=>this.getSubtreeMetric(e));t+=Math.max(...r,0)}return t}}const i=e=>{const t=e.details.actualTime;return"N/A"===t||null==t?0:parseFloat(t)||0},c=e=>{const t=e.details.cost;return"N/A"===t||null==t?0:parseFloat(t)||0};function u(e){const t=d(e.Plan,null);o(t);const r=function(e,t="time",r){let s;if(e.id||o(e),"time"===t)s=new a(i);else if("cost"===t)s=new l(c);else{if("custom"!==t||!r)throw new Error("Invalid metric or missing custom extractor");s=new a(r)}return s.analyze(e)}(t,"time"),s=function(e){const t=new Map,r=[];return function e(s){if(s){if(s.details?.subplanName&&s.details.subplanName.startsWith("CTE ")){const e=s.details.subplanName.substring(4);t.set(e,{cteName:e,rootNodeId:s.id,rootNode:s})}if("CTE Scan"===s.name&&s.details?.cteName){const e=s.details.cteName,o=t.get(e),n=o?o.rootNodeId:null;r.push({nodeId:s.id,cteName:e,targetCTENodeId:n})}s.children&&Array.isArray(s.children)&&s.children.forEach(t=>e(t))}}(e),r.forEach(e=>{if(!e.targetCTENodeId){const r=t.get(e.cteName);r&&(e.targetCTENodeId=r.rootNodeId)}}),{cteDefinitions:t,cteReferences:r}}(t);return{tree:t,criticalPath:r,rootCost:e.Plan["Total Cost"]||0,rootTime:e.Plan["Actual Total Time"]||0,cteMetadata:s}}function d(e,t){const r=function(e){const t=(r=e["Plan Rows"]||0,o=e["Actual Rows"]||0,r&&0!==r?o/r:1);var r,o;return{name:e["Node Type"]||"Unknown",rawNode:e,details:{cost:e["Total Cost"]?e["Total Cost"].toFixed(2):"N/A",startupCost:e["Startup Cost"]?e["Startup Cost"].toFixed(2):"N/A",planRows:e["Plan Rows"]||"N/A",actualRows:e["Actual Rows"]||"N/A",actualTime:e["Actual Total Time"]?e["Actual Total Time"].toFixed(3):"N/A",startupTime:e["Actual Startup Time"]?e["Actual Startup Time"].toFixed(3):"N/A",subplanName:e["Subplan Name"]||null,cteName:e["CTE Name"]||null,relation:e["Relation Name"]||null,alias:e.Alias||null,schema:e.Schema||null,indexName:e["Index Name"]||null,joinType:e["Join Type"]||null,hashCond:e["Hash Cond"]||null,joinFilter:e["Join Filter"]||null,innerUnique:e["Inner Unique"]||null,parentRelationship:e["Parent Relationship"]||null,filter:e.Filter||null,sortKey:e["Sort Key"]?e["Sort Key"].join(", "):null,sortMethod:e["Sort Method"]||null,sortSpaceUsed:e["Sort Space Used"]||null,sortSpaceType:e["Sort Space Type"]||null,strategy:e.Strategy||null,groupKey:e["Group Key"]?e["Group Key"].join(", "):null,hashAggBatches:e["HashAgg Batches"]||null,peakMemoryUsage:e["Peak Memory Usage"]||null,hashBuckets:e["Hash Buckets"]||null,hashBatches:e["Hash Batches"]||null,sharedHitBlocks:e["Shared Hit Blocks"]||0,sharedReadBlocks:e["Shared Read Blocks"]||0,sharedDirtiedBlocks:e["Shared Dirtied Blocks"]||0,sharedWrittenBlocks:e["Shared Written Blocks"]||0,localHitBlocks:e["Local Hit Blocks"]||0,localReadBlocks:e["Local Read Blocks"]||0,tempReadBlocks:e["Temp Read Blocks"]||0,tempWrittenBlocks:e["Temp Written Blocks"]||0,ioReadTime:e["I/O Read Time"]||null,ioWriteTime:e["I/O Write Time"]||null,rowsRemovedByFilter:e["Rows Removed by Filter"]||null,rowsRemovedByJoinFilter:e["Rows Removed by Join Filter"]||null,heapFetches:e["Heap Fetches"]||null,exactHeapBlocks:e["Exact Heap Blocks"]||null,lossyHeapBlocks:e["Lossy Heap Blocks"]||null,workersPlanned:e["Workers Planned"]||null,workersLaunched:e["Workers Launched"]||null,output:e.Output?e.Output.join(", "):null,estimationAccuracy:t,estimationOff:s(t),loops:e["Actual Loops"]||1}}}(e),o=function(e,t){return t?e["Hash Cond"]?e["Hash Cond"]:e["Join Filter"]?e["Join Filter"]:e["Parent Relationship"]?e["Parent Relationship"]:null:null}(e,t),n={...r,children:[],edgeLabel:o};return e.Plans&&e.Plans.length>0&&(n.children=e.Plans.map(t=>d(t,e))),n}void 0!==e.g&&(e.g.runExplain=function(e){const t=new r(e);try{const e=t.getQuery();if(!e.success)return void t.showError(e.error);let r=e.query;r=function(e){return e?e.trim().replace(/;+$/,"").trim():""}(r);const s=function(e){return e&&0!==e.trim().length?/^\s*EXPLAIN/i.test(e)?{valid:!1,error:"ALREADY_EXPLAINED"}:/^\s*(SELECT|INSERT|UPDATE|DELETE|WITH)/i.test(e)?{valid:!0}:{valid:!1,error:"INVALID_QUERY"}:{valid:!1,error:"NO_QUERY"}}(r);if(!s.valid)return void t.showError(s.error);const o=function(e,t={}){const{analyze:r=!0,costs:s=!0,verbose:o=!0,buffers:n=!0,format:a="JSON"}=t,l=[];return r&&l.push("ANALYZE"),s&&l.push("COSTS"),o&&l.push("VERBOSE"),n&&l.push("BUFFERS"),a&&l.push(`FORMAT ${a}`),`EXPLAIN (${l.join(", ")}) ${e}`}(r);t.executeQuery(o,e=>{try{const s=function(e){if(!e||!e.rows||0===e.rows.length)return{success:!1,error:"NO_RESULT"};const t=Object.keys(e.columns||{});if(0===t.length)return{success:!1,error:"NO_COLUMNS"};const r=t[0],s=e.rows[0].raw(r);return s?{success:!0,data:s}:{success:!1,error:"NO_PLAN_DATA"}}(e);if(!s.success)return void t.showError(s.error);const o=function(e){try{let t=JSON.parse(e);return Array.isArray(t)&&t.length>0&&(t=t[0]),t&&t.Plan?{success:!0,data:t}:{success:!1,error:"INVALID_PLAN_STRUCTURE"}}catch(e){return{success:!1,error:"PARSE_ERROR",message:e.message}}}(s.data);if(!o.success)return void t.showError(o.error,o.message);const n=o.data,a=u(n),l="app/dist/index.html",i=t.loadWebView(l);t.sendDataToWebView(i,{query:r,planData:n,treeData:a.tree,criticalPath:a.criticalPath,rootCost:a.rootCost,rootTime:a.rootTime})}catch(e){t.showAlert("Error Processing EXPLAIN",e.message||String(e))}})}catch(e){t.showAlert("Unexpected Error",e.message||String(e))}})})();
//# sourceMappingURL=explain.js.map